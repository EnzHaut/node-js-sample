version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2004:current
    working_directory: ~/app
    steps:
      - checkout

      - run:
          name: Build Docker image
          command: |
            docker build -t enzoropert66/mon-app-node:latest .
            
      - run:
          name: Test Docker container
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker run -d --rm -p 8080:8080 $DOCKERHUB_USERNAME/node-js-sample:$TAG
            sleep 5
            curl -f http://localhost:8080 || (echo "App test failed!" && exit 1)

      - run:
          name: Push Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $DOCKERHUB_USERNAME/node-js-sample:$TAG